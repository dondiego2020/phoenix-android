# پیکربندی پیشرفته (Configuration)

در این بخش با پیکربندی حالت‌های امنیتی مختلف آشنا می‌شویم.
ما استفاده از **حالت mTLS** را اکیداً پیشنهاد می‌کنیم؛ اما از آنجایی که مراحل راه‌اندازی mTLS شامل تمام مراحل One-Way TLS می‌شود، ابتدا به توضیح One-Way TLS می‌پردازیم.
بنابراین اگر قصد پیاده‌سازی mTLS را دارید، ابتدا مراحل One-Way TLS را انجام دهید و سپس بخش مربوط به mTLS را دنبال کنید.

---

## ۱. پیکربندی One-Way TLS (مانند HTTPS)

در این حالت، سرور دارای کلید خصوصی است و کلاینت با داشتن کلید عمومی سرور، از صحت اتصال اطمینان حاصل می‌کند.

### مرحله ۱: ایجاد کلید سرور
در سرور (VPS) دستور زیر را اجرا کنید:

```bash
./phoenix-server -gen-keys
```

خروجی این دستور شامل دو مورد است:
1.  یک فایل به نام `private.key` در همان پوشه ساخته می‌شود.
2.  یک **Public Key** (کلید عمومی) در خروجی ترمینال چاپ می‌شود. **آن را کپی و ذخیره کنید.**

سپس برای هماهنگی با فایل کانفیگ پیش‌فرض، نام فایل کلید خصوصی را تغییر دهید:
```bash
mv private.key server.private.key
```

### مرحله ۲: تنظیم سرور (`server.toml`)
فایل `server.toml` را باز کنید و خط مربوط به `private_key` را از حالت کامنت (با حذف `#`) خارج کنید:

```toml
[security]
# ...
private_key = "server.private.key"
```

### مرحله ۳: تنظیم کلاینت (`client.toml`)
در کامپیوتر خود، فایل `client.toml` را باز کنید. متغیر `server_public_key` را پیدا کرده، از کامنت خارج کنید و مقدار آن را برابر با **کلید عمومی سرور** (که در مرحله ۱ ذخیره کردید) قرار دهید:

```toml
server_public_key = "YOUR_SERVER_PUBLIC_KEY..."
```

**تبریک!** اکنون حالت One-Way TLS فعال شده است و می‌توانید از برنامه استفاده کنید.

---

## ۲. پیکربندی mTLS (احراز هویت دوطرفه - پیشنهادی)

برای حداکثر امنیت (ضد-Probing)، پس از انجام مراحل بالا (One-Way TLS)، مراحل زیر را نیز انجام دهید.

### مرحله ۴: ایجاد کلید کلاینت
در کامپیوتر خود (سمت کلاینت) دستور زیر را اجرا کنید:

```bash
./phoenix-client -gen-keys
# یا در ویندوز:
# .\phoenix-client.exe -gen-keys
```

خروجی مانند قبل است:
1.  فایل `private.key` ساخته می‌شود.
2.  یک **Public Key** به شما نمایش داده می‌شود. **آن را کپی و ذخیره کنید.**

نام فایل کلید خصوصی را تغییر دهید:
```bash
mv private.key client.private.key
# یا در ویندوز (PowerShell):
# Rename-Item private.key client.private.key
```

### مرحله ۵: تنظیم کلاینت (`client.toml`)
فایل `client.toml` را باز کنید و خط مربوط به `private_key` را از کامنت خارج کنید:

```toml
# مسیر کلید خصوصی کلاینت که همین الان ساختید
private_key = "client.private.key"
```

### مرحله ۶: تنظیم سرور (`server.toml`)
به سرور برگردید و فایل `server.toml` را باز کنید.
متغیر `authorized_clients` (لیست کلاینت‌های مجاز) را از کامنت خارج کنید و کلید عمومی کلاینت (که در مرحله ۴ گرفتید) را داخل آن قرار دهید:

```toml
[security]
# ...
authorized_clients = [
  "CLIENT_PUBLIC_KEY..."
]
```

**تمام شد!** حالا کافیست سرور و کلاینت را اجرا کنید. در این حالت فقط کلاینت شما اجازه اتصال به سرور را دارد.

::: tip نکته مهم در مورد نام فایل‌ها
در تمام مراحل بالا ما با دستور `mv` (تغییر نام) نام فایل‌های `private.key` ایجاد شده را به `server.private.key` و `client.private.key` تغییر دادیم تا با فایل‌های کانفیگ پیش‌فرض (`server.toml` و `client.toml`) هماهنگ شوند.
اگر نمی‌خواهید نام فایل‌ها را تغییر دهید، باید مقدار متغیر `private_key` را در فایل‌های کانفیگ ویرایش کرده و آدرس/نام فایل خود را وارد کنید.
:::

::: tip بازگشت به اجرا
حالا که حداقل یکی از حالت‌های امنیتی را فعال نموده‌اید، می‌توانید به صفحه قبل (**نصب و راه‌اندازی**) بازگشته و با مطالعه بخش **اجرای برنامه**، سرویس خود را با خیالی آسوده اجرا کنید.
:::
