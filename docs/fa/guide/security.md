# امنیت و رمزنگاری (Security & Encryption)

ققنوس (Phoenix) برای ایجاد کانال امن در شبکه‌های پر از تهدید طراحی شده است.

## ۱. مدل تهدید (Threat Model)

ما فرض می‌کنیم:
- **Client (کلاینت):** دستگاه کاربر قابل اعتماد است.
- **Server (سرور):** سرور ققنوس امن است و تحت کنترل کاربر.
- **Network (مسیر):** اینترنت، ISP، و DPI کاملاً ناامن و دشمن هستند.
  - **DPI:** می‌تواند محتوا، اندازه و الگوی ترافیک را ببیند.
  - **Active Probing:** می‌تواند به سرور شما وصل شود و سعی کند سرویس‌های شما را کشف کند.
  - **MITM:** می‌تواند تلاش کند با گواهی جعلی ترافیک شما را شنود کند (حمله مرد میانی).

## ۲. حالت‌های امنیتی (Security Modes)

### الف. حالت mTLS (احراز هویت دوطرفه) - **حداکثر امنیت**
- **امنیت:** سرور فقط به کلاینت‌های شناخته شده (کلید عمومی ذخیره شده) پاسخ می‌دهد.
- **رمزنگاری:** ترافیک با **TLS 1.3** و **ChaCha20-Poly1305** رمزنگاری می‌شود.
- **Pinning:** کلاینت کلید عمومی سرور را پین می‌کند (نیاز به CA نیست).
- **ضد-Probing:** اگر مامور فیلترینگ IP سرور شما را پیدا کند و درخواستی بفرستد، چون کلید خصوصی کلاینت را ندارد، اتصال فوراً قطع می‌شود (Connection Refused/Reset).

### ب. حالت One-Way TLS (مانند HTTPS) - **امنیت استاندارد**
- **امنیت:** سرور هر کلاینتی که پروتکل صحیح را بداند قبول می‌کند.
- **رمزنگاری:** همانند mTLS (قوی).
- **ناشناس بودن:** کلاینت نیازی به کلید خصوصی ندارد.
- **آسیب‌پذیری:** در برابر Probing پیشرفته آسیب‌پذیر است (اگر فیلترچی پروتکل ققنوس را بداند می‌تواند به سرور وصل شود، اما محتوای ترافیک شما را نمی‌بیند).
- **کاربرد:** پراکسی‌های عمومی، تانل‌های سریع و اشتراکی.

### ج. حالت h2c (متن آشکار) - **مخفی‌کاری**
- **امنیت:** بدون رمزنگاری لایه TLS.
- **مخفی‌کاری:** خود را کاملاً شبیه ترافیک HTTP عادی نشان می‌دهد.
- **کاربرد:** استفاده پشت **Cloudflare (CDN)** یا Load Balancerهایی که TLS Termination را انجام می‌دهند.

## ۳. مکانیزم‌های دفاعی فعال (Active Defense)

### Circuit Breaker & Hard Reset
برای مقابله با اختلالات فعال شبکه (Active Probing / Reset Storms):
- کلاینت خطاهای اتصال را می‌شمارد.
- اگر اتصال قطع شد، **Hard Reset** انجام می‌شود (تخریب کامل استخر HTTP/2 و ساخت مجدد).
- **Debounce:** برای جلوگیری از حملات بازگشتی، ریست‌ها با تاخیر ۵ ثانیه‌ای انجام می‌شوند.

### Ed25519 Signatures
ما از الگوریتم مدرن **Ed25519** برای همه کارهای رمزنگاری (تولید کلید، امضای گواهی) استفاده می‌کنیم.
- **سرعت بالا:** بسیار سریعتر از RSA و امن‌تر از ECDSA قدیمی.
- **کلید کوچک:** کلیدهای ۳۲ بایتی که به راحتی در فایل کانفیگ جا می‌شوند.
- **مقاوم در برابر کوانتوم:** خیر (در نسخه ۲.۰ برنامه‌ریزی شده).

## ۴. بهترین روش‌ها (Best Practices)

1. **همیشه از mTLS استفاده کنید.** اگر سرور شخصی دارید، فقط خودتان باید بتوانید وصل شوید.
2. **کلیدها را دوره‌ای عوض کنید.** هر چند ماه یکبار با `-gen-keys` کلید جدید بسازید.
3. **همیشه آپدیت بمانید.** ما مرتباً obfuscation را بهبود می‌دهیم.
4. **از CDN استفاده کنید.** اگر IP سرور شما بلاک شد، حالت h2c را پشت کلاودفلر فعال کنید تا IP مخفی بماند.
